# SoulArt - Balance & Payment System

## рЃАрЃўрЃАрЃбрЃћрЃЏрЃўрЃА рЃљрЃдрЃгрЃћрЃарЃљ

рЃАрЃћрЃџрЃћрЃарЃћрЃЉрЃўрЃА balance рЃЊрЃљ payment рЃАрЃўрЃАрЃбрЃћрЃЏрЃљ, рЃарЃЮрЃЏрЃћрЃџрЃўрЃф рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃљрЃЊ рЃњрЃљрЃюрЃљрЃгрЃўрЃџрЃћрЃЉрЃА рЃЊрЃљ рЃњрЃљрЃЊрЃљрЃБрЃарЃўрЃфрЃ«рЃљрЃЋрЃА рЃЌрЃљрЃюрЃ«рЃљрЃА рЃАрЃћрЃџрЃћрЃарЃћрЃЉрЃА BOG-рЃўрЃА API-рЃўрЃЌ.

## рЃцрЃБрЃюрЃЦрЃфрЃўрЃЮрЃюрЃљрЃџрЃў

### ­ЪЈд Balance Management

- **рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃў рЃЉрЃљрЃџрЃљрЃюрЃАрЃўрЃА рЃњрЃљрЃЏрЃЮрЃЌрЃЋрЃџрЃљ**: рЃарЃЮрЃЊрЃћрЃАрЃљрЃф рЃерЃћрЃЎрЃЋрЃћрЃЌрЃљ рЃЏрЃўрЃбрЃљрЃюрЃўрЃџрЃўрЃљ (`delivered` status)
- **рЃЎрЃЮрЃЏрЃўрЃАрЃўрЃћрЃЉрЃўрЃА рЃњрЃљрЃЏрЃЮрЃЦрЃЋрЃўрЃЌрЃЋрЃљ**:
  - рЃАрЃљрЃўрЃбрЃўрЃА рЃЎрЃЮрЃЏрЃўрЃАрЃўрЃЮ: 10%
  - рЃЏрЃўрЃбрЃљрЃюрЃўрЃА рЃЎрЃЮрЃЏрЃўрЃАрЃўрЃЮ: 5% (рЃЏрЃўрЃюрЃўрЃЏрЃБрЃЏ 10 рЃџрЃљрЃарЃў) рЃЌрЃБ SoulArt-рЃўрЃА рЃЏрЃўрЃбрЃљрЃюрЃљрЃљ
- **рЃЉрЃљрЃџрЃљрЃюрЃАрЃўрЃА рЃўрЃАрЃбрЃЮрЃарЃўрЃљ**: рЃЌрЃўрЃЌрЃЮрЃћрЃБрЃџрЃў рЃбрЃарЃљрЃюрЃќрЃљрЃЦрЃфрЃўрЃўрЃА рЃЊрЃћрЃбрЃљрЃџрЃБрЃарЃў рЃарЃћрЃЎрЃЮрЃарЃЊрЃў

### ­Ъњ│ Bank Integration

- **BOG Bank API**: рЃюрЃљрЃЏрЃЊрЃЋрЃўрЃџрЃў рЃЉрЃљрЃюрЃЎрЃўрЃА рЃўрЃюрЃбрЃћрЃњрЃарЃљрЃфрЃўрЃљ рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃў рЃњрЃљрЃЊрЃљрЃарЃўрЃфрЃ«рЃЋрЃћрЃЉрЃўрЃАрЃЌрЃЋрЃўрЃА
- **рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃБрЃарЃў Withdrawals**: рЃАрЃћрЃџрЃћрЃарЃў рЃЋрЃћрЃа рЃЏрЃўрЃўрЃдрЃћрЃЉрЃА рЃЌрЃљрЃюрЃ«рЃљрЃА 15 рЃџрЃљрЃарЃќрЃћ рЃюрЃљрЃЎрЃџрЃћрЃЉрЃў рЃЌрЃБ рЃљрЃарЃўрЃА
- **Account Validation**: рЃљрЃюрЃњрЃљрЃарЃўрЃерЃўрЃА рЃюрЃЮрЃЏрЃарЃўрЃА рЃЋрЃљрЃџрЃўрЃЊрЃљрЃфрЃўрЃљ BOG API-рЃўрЃЌ

### ­ЪЊД Email Notifications

- **рЃерЃћрЃЎрЃЋрЃћрЃЌрЃўрЃА рЃЊрЃљрЃЊрЃљрЃАрЃбрЃБрЃарЃћрЃЉрЃљ**: рЃЏрЃДрЃўрЃЊрЃЋрЃћрЃџрЃўрЃАрЃЌрЃЋрЃўрЃА рЃЊрЃљ рЃАрЃћрЃџрЃћрЃарЃўрЃАрЃЌрЃЋрЃўрЃА
- **рЃЏрЃўрЃбрЃљрЃюрЃўрЃА рЃЊрЃљрЃЊрЃљрЃАрЃбрЃБрЃарЃћрЃЉрЃљ**: рЃЏрЃДрЃўрЃЊрЃЋрЃћрЃџрЃўрЃАрЃЌрЃЋрЃўрЃА
- **Balance Withdrawal**: рЃњрЃљрЃЊрЃљрЃарЃўрЃфрЃ«рЃЋрЃўрЃА рЃерЃћрЃбрЃДрЃЮрЃЉрЃўрЃюрЃћрЃЉрЃљ

---

## рЃбрЃћрЃЦрЃюрЃўрЃЎрЃБрЃарЃў рЃЊрЃћрЃбрЃљрЃџрЃћрЃЉрЃў

### Backend Architecture

#### 1. Database Schemas

**SellerBalance Schema** (`server/src/users/schemas/seller-balance.schema.ts`)

```typescript
{
  sellerId: ObjectId,          // рЃАрЃћрЃџрЃћрЃарЃўрЃА ID
  availableBalance: Number,    // рЃ«рЃћрЃџрЃЏрЃўрЃАрЃљрЃгрЃЋрЃЊрЃЮрЃЏрЃў рЃЉрЃљрЃџрЃљрЃюрЃАрЃў
  totalEarnings: Number,       // рЃ»рЃљрЃЏрЃБрЃарЃў рЃерЃћрЃЏрЃЮрЃАрЃљрЃЋрЃљрЃџрЃў
  totalWithdrawn: Number,      // рЃ»рЃљрЃЏрЃБрЃарЃў рЃњрЃљрЃЊрЃљрЃарЃўрЃфрЃ«рЃБрЃџрЃў
  accountNumber: String,       // рЃЉрЃљрЃюрЃЎрЃўрЃА рЃљрЃюрЃњрЃљрЃарЃўрЃерЃў
  lastUpdated: Date
}
```

**BalanceTransaction Schema**

```typescript
{
  sellerId: ObjectId,
  orderId: ObjectId,
  type: 'earning' | 'withdrawal',
  amount: Number,
  commission: Number,
  description: String,
  transactionId: String,       // BOG рЃбрЃарЃљрЃюрЃќрЃљрЃЦрЃфрЃўрЃўрЃА ID
  status: 'pending' | 'completed' | 'failed'
}
```

#### 2. Services

**BalanceService** (`server/src/users/services/balance.service.ts`)

- `processOrderEarnings()`: рЃерЃћрЃЎрЃЋрЃћрЃЌрЃўрЃА earning-рЃўрЃА рЃЊрЃљрЃЏрЃБрЃерЃљрЃЋрЃћрЃЉрЃљ
- `requestWithdrawal()`: withdrawal request-рЃўрЃА рЃЏрЃБрЃерЃљрЃЋрЃћрЃЉрЃљ
- `getSellerBalance()`: рЃАрЃћрЃџрЃћрЃарЃўрЃА рЃЉрЃљрЃџрЃљрЃюрЃАрЃўрЃА рЃЏрЃЮрЃФрЃўрЃћрЃЉрЃљ

**BankIntegrationService** (`server/src/users/services/bog-bank-integration.service.ts`)

- `transferToSeller()`: BOG API-рЃўрЃЌ рЃњрЃљрЃЊрЃљрЃарЃўрЃфрЃ«рЃЋрЃљ
- `validateAccount()`: рЃљрЃюрЃњрЃљрЃарЃўрЃерЃўрЃА рЃЋрЃљрЃџрЃўрЃЊрЃљрЃфрЃўрЃљ

**EmailService** (`server/src/email/services/email.services.ts`)

- `sendOrderConfirmation()`: рЃерЃћрЃЎрЃЋрЃћрЃЌрЃўрЃА рЃЊрЃљрЃЊрЃљрЃАрЃбрЃБрЃарЃћрЃЉрЃљ
- `sendNewOrderNotificationToSeller()`: рЃАрЃћрЃџрЃћрЃарЃўрЃАрЃЌрЃЋрЃўрЃА рЃљрЃ«рЃљрЃџрЃў рЃерЃћрЃЎрЃЋрЃћрЃЌрЃљ
- `sendDeliveryConfirmation()`: рЃЏрЃўрЃбрЃљрЃюрЃўрЃА рЃЊрЃљрЃЊрЃљрЃАрЃбрЃБрЃарЃћрЃЉрЃљ
- `sendWithdrawalNotification()`: withdrawal рЃерЃћрЃбрЃДрЃЮрЃЉрЃўрЃюрЃћрЃЉрЃљ

#### 3. API Endpoints

**Balance Controller** (`/api/balance`)

```
GET    /balance/seller/:sellerId     - рЃАрЃћрЃџрЃћрЃарЃўрЃА рЃЉрЃљрЃџрЃљрЃюрЃАрЃў
POST   /balance/withdrawal           - withdrawal request
GET    /balance/transactions/:sellerId - рЃбрЃарЃљрЃюрЃќрЃљрЃЦрЃфрЃўрЃћрЃЉрЃўрЃА рЃўрЃАрЃбрЃЮрЃарЃўрЃљ
GET    /balance/admin/all            - рЃДрЃЋрЃћрЃџрЃљ рЃАрЃћрЃџрЃћрЃарЃўрЃА рЃЉрЃљрЃџрЃљрЃюрЃАрЃў (admin)
```

### Frontend Components

#### 1. Seller Balance Dashboard

**рЃЏрЃўрЃАрЃљрЃЏрЃљрЃарЃЌрЃў**: `/profile/balance`
**рЃцрЃљрЃўрЃџрЃў**: `web/src/app/profile/balance/page.tsx`

**рЃцрЃБрЃюрЃЦрЃфрЃўрЃЮрЃюрЃљрЃџрЃў**:

- рЃЉрЃљрЃџрЃљрЃюрЃАрЃўрЃА рЃЕрЃЋрЃћрЃюрЃћрЃЉрЃљ (рЃ«рЃћрЃџрЃЏрЃўрЃАрЃљрЃгрЃЋрЃЊрЃЮрЃЏрЃў/рЃ»рЃљрЃЏрЃБрЃарЃў/рЃњрЃљрЃЊрЃљрЃарЃўрЃфрЃ«рЃБрЃџрЃў)
- Withdrawal Form (15 рЃџрЃљрЃарЃўрЃА рЃЏрЃўрЃюрЃўрЃЏрЃБрЃЏрЃўрЃЌ)
- рЃбрЃарЃљрЃюрЃќрЃљрЃЦрЃфрЃўрЃћрЃЉрЃўрЃА рЃўрЃАрЃбрЃЮрЃарЃўрЃљ
- BOG рЃљрЃюрЃњрЃљрЃарЃўрЃерЃўрЃА рЃЏрЃљрЃарЃЌрЃЋрЃљ

#### 2. Admin Balances Page

**рЃЏрЃўрЃАрЃљрЃЏрЃљрЃарЃЌрЃў**: `/admin/balances`
**рЃцрЃљрЃўрЃџрЃў**: `web/src/app/admin/balances/page.tsx`

**рЃцрЃБрЃюрЃЦрЃфрЃўрЃЮрЃюрЃљрЃџрЃў**:

- рЃДрЃЋрЃћрЃџрЃљ рЃАрЃћрЃџрЃћрЃарЃўрЃА рЃЉрЃљрЃџрЃљрЃюрЃАрЃў
- рЃАрЃћрЃџрЃћрЃарЃћрЃЉрЃўрЃА рЃерЃћрЃЏрЃЮрЃАрЃљрЃЋрЃџрЃћрЃЉрЃўрЃА рЃерЃћрЃ»рЃљрЃЏрЃћрЃЉрЃљ
- рЃбрЃарЃљрЃюрЃќрЃљрЃЦрЃфрЃўрЃћрЃЉрЃўрЃА рЃЏрЃЮрЃюрЃўрЃбрЃЮрЃарЃўрЃюрЃњрЃў

### Navigation

- **Seller Menu**: "рЃЕрЃћрЃЏрЃў рЃЉрЃљрЃџрЃљрЃюрЃАрЃў" рЃџрЃўрЃюрЃЎрЃў user menu-рЃерЃў
- **Admin Menu**: "Balance Management" рЃџрЃўрЃюрЃЎрЃў admin menu-рЃерЃў

---

## рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃљ

### Environment Variables

#### Backend (.env)

```bash
# BOG Bank API
BOG_CLIENT_ID=your_bog_client_id
BOG_CLIENT_SECRET=your_bog_client_secret
BOG_API_URL=https://api.bog.ge
BOG_ENVIRONMENT=production  # рЃљрЃю development

# Email Configuration
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USER=your_email@gmail.com
EMAIL_PASS=your_app_password
ADMIN_EMAIL=admin@soulart.ge

# Database
MONGODB_URI=your_mongodb_connection_string
```

#### Frontend (.env.local)

```bash
NEXT_PUBLIC_API_URL=http://localhost:4000
```

### BOG Bank API Setup

1. **BOG Developer Portal-рЃќрЃћ рЃарЃћрЃњрЃўрЃАрЃбрЃарЃљрЃфрЃўрЃљ**
2. **API Credentials-рЃўрЃА рЃЏрЃўрЃдрЃћрЃЉрЃљ** (CLIENT_ID, CLIENT_SECRET)
3. **Webhook URLs-рЃўрЃА рЃЎрЃЮрЃюрЃцрЃўрЃњрЃБрЃарЃљрЃфрЃўрЃљ** (transaction confirmations)
4. **Production Environment-рЃерЃў рЃњрЃљрЃЊрЃљрЃбрЃљрЃюрЃљ**

---

## Workflow

### 1. рЃерЃћрЃЎрЃЋрЃћрЃЌрЃўрЃА рЃЏрЃўрЃдрЃћрЃЉрЃљ

1. рЃЏрЃДрЃўрЃЊрЃЋрЃћрЃџрЃў рЃцрЃљрЃЊрЃўрЃарЃћрЃЉрЃА рЃерЃћрЃЎрЃЋрЃћрЃЌрЃљрЃА
2. `OrdersService.payOrder()` рЃўрЃњрЃќрЃљрЃЋрЃюрЃћрЃЉрЃљ
3. Email notification-рЃћрЃЉрЃў:
   - рЃЏрЃДрЃўрЃЊрЃЋрЃћрЃџрЃўрЃАрЃЌрЃЋрЃўрЃА: рЃерЃћрЃЎрЃЋрЃћрЃЌрЃўрЃА рЃЊрЃљрЃЊрЃљрЃАрЃбрЃБрЃарЃћрЃЉрЃљ
   - рЃАрЃћрЃџрЃћрЃарЃўрЃАрЃЌрЃЋрЃўрЃА: рЃљрЃ«рЃљрЃџрЃў рЃерЃћрЃЎрЃЋрЃћрЃЌрЃўрЃА рЃерЃћрЃбрЃДрЃЮрЃЉрЃўрЃюрЃћрЃЉрЃљ

### 2. рЃЏрЃўрЃбрЃљрЃюрЃўрЃА рЃЊрЃљрЃЊрЃљрЃАрЃбрЃБрЃарЃћрЃЉрЃљ

1. рЃљрЃЊрЃЏрЃўрЃюрЃў рЃљрЃю рЃЎрЃБрЃарЃўрЃћрЃарЃў рЃљрЃдрЃюрЃўрЃерЃюрЃљрЃЋрЃА `delivered` status
2. `OrdersService.updateDelivered()` рЃўрЃњрЃќрЃљрЃЋрЃюрЃћрЃЉрЃљ
3. `BalanceService.processOrderEarnings()` - earning-рЃўрЃА рЃњрЃљрЃЏрЃЮрЃЌрЃЋрЃџрЃљ:
   ```typescript
   const siteCommission = productPrice * 0.1; // 10%
   const deliveryCommission = isOwnDelivery
     ? Math.max(productPrice * 0.05, 10)
     : 0;
   const sellerEarning = productPrice - siteCommission - deliveryCommission;
   ```
4. Email: рЃЏрЃДрЃўрЃЊрЃЋрЃћрЃџрЃўрЃАрЃЌрЃЋрЃўрЃА рЃЏрЃўрЃбрЃљрЃюрЃўрЃА рЃЊрЃљрЃЊрЃљрЃАрЃбрЃБрЃарЃћрЃЉрЃљ

### 3. Withdrawal Process

1. рЃАрЃћрЃџрЃћрЃарЃў рЃўрЃЌрЃ«рЃЮрЃЋрЃА withdrawal (рЃЏрЃўрЃюрЃўрЃЏрЃБрЃЏ 15 рЃџрЃљрЃарЃў)
2. `BalanceService.requestWithdrawal()`:
   - рЃЉрЃљрЃџрЃљрЃюрЃАрЃўрЃА рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃљ
   - BOG API-рЃўрЃЌ рЃњрЃљрЃЊрЃљрЃарЃўрЃфрЃ«рЃЋрЃљ
   - Transaction record-рЃўрЃА рЃерЃћрЃЦрЃЏрЃюрЃљ
3. Email notifications:
   - рЃАрЃћрЃџрЃћрЃарЃўрЃАрЃЌрЃЋрЃўрЃА: рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃБрЃџрЃў рЃњрЃљрЃЊрЃљрЃарЃўрЃфрЃ«рЃЋрЃљ
   - рЃљрЃЊрЃЏрЃўрЃюрЃўрЃАрЃЌрЃЋрЃўрЃА: рЃњрЃљрЃЊрЃљрЃарЃўрЃфрЃ«рЃЋрЃўрЃА рЃерЃћрЃбрЃДрЃЮрЃЉрЃўрЃюрЃћрЃЉрЃљ

---

## Testing

### Backend Testing

```bash
cd server
npm run test            # Unit tests
npm run test:e2e        # End-to-end tests
npm run test:cov        # Coverage report
```

### рЃЏрЃюрЃўрЃерЃЋрЃюрЃћрЃџрЃЮрЃЋрЃљрЃюрЃў Test Cases

1. **Balance Calculation**: рЃЎрЃЮрЃЏрЃўрЃАрЃўрЃћрЃЉрЃўрЃА рЃАрЃгрЃЮрЃарЃў рЃњрЃљрЃЏрЃЮрЃЌрЃЋрЃџрЃљ
2. **BOG API Integration**: рЃЉрЃљрЃюрЃЎрЃўрЃА API-рЃўрЃА рЃЏрЃБрЃерЃљрЃЮрЃЉрЃљ
3. **Email Notifications**: рЃДрЃЋрЃћрЃџрЃљ email template-рЃўрЃА рЃбрЃћрЃАрЃбрЃўрЃарЃћрЃЉрЃљ
4. **Error Handling**: рЃЦрЃАрЃћрЃџрЃўрЃА рЃерЃћрЃцрЃћрЃарЃ«рЃћрЃЉрЃћрЃЉрЃў, API failures
5. **Security**: Role-based access control

---

## Production Deployment

### Backend

```bash
# Build
npm run build

# Start production server
npm run start:prod
```

### Frontend

```bash
# Build
npm run build

# Deploy (Vercel example)
vercel --prod
```

### Database Migration

```bash
# рЃЏрЃЮрЃюрЃљрЃфрЃћрЃЏрЃЌрЃљ рЃЉрЃљрЃќрЃўрЃА migration (рЃЌрЃБ рЃАрЃљрЃГрЃўрЃарЃЮрЃљ)
npm run migration:up
```

---

## рЃЏрЃЮрЃюрЃўрЃбрЃЮрЃарЃўрЃюрЃњрЃў

### Logs

- **Balance Transactions**: рЃДрЃЋрЃћрЃџрЃљ financial transaction
- **BOG API Calls**: рЃЉрЃљрЃюрЃЎрЃўрЃА API-рЃўрЃА request/response logs
- **Email Delivery**: Email рЃњрЃљрЃњрЃќрЃљрЃЋрЃюрЃћрЃЉрЃўрЃА logs
- **Error Tracking**: Production errors (Sentry рЃарЃћрЃЎрЃЮрЃЏрЃћрЃюрЃЊрЃўрЃарЃћрЃЉрЃБрЃџрЃўрЃљ)

### Metrics

- рЃАрЃћрЃџрЃћрЃарЃћрЃЉрЃўрЃА рЃАрЃљрЃерЃБрЃљрЃџрЃЮ рЃерЃћрЃЏрЃЮрЃАрЃљрЃЋрЃљрЃџрЃў
- withdrawal-рЃћрЃЉрЃўрЃА рЃАрЃўрЃ«рЃерЃўрЃарЃћ
- BOG API success rate
- Email delivery rate

---

## Support

### Admin Functions

- рЃЉрЃљрЃџрЃљрЃюрЃАрЃћрЃЉрЃўрЃА рЃЏрЃљрЃюрЃБрЃљрЃџрЃБрЃарЃў рЃЎрЃЮрЃарЃћрЃЦрЃбрЃўрЃарЃћрЃЉрЃљ
- withdrawal-рЃћрЃЉрЃўрЃА manual processing
- рЃбрЃарЃљрЃюрЃќрЃљрЃЦрЃфрЃўрЃћрЃЉрЃўрЃА refund/cancel

### Debug Tools

- Balance recalculation scripts
- Email notification resend
- BOG API status checker

---

## рЃБрЃАрЃљрЃцрЃарЃЌрЃ«рЃЮрЃћрЃЉрЃљ

### Data Protection

- рЃАрЃћрЃџрЃћрЃарЃћрЃЉрЃўрЃА рЃЉрЃљрЃюрЃЎрЃўрЃА рЃЏрЃЮрЃюрЃљрЃфрЃћрЃЏрЃћрЃЉрЃў encrypted
- API tokens secure storage-рЃерЃў
- User roles рЃЊрЃљ permissions

### Financial Security

- Double-entry accounting system
- Transaction audit trails
- Rate limiting BOG API calls
- Withdrawal amount limits

---

## рЃЏрЃЮрЃЏрЃљрЃЋрЃљрЃџрЃў Features

### Short Term

- SMS notifications withdrawal-рЃћрЃЉрЃўрЃАрЃЌрЃЋрЃўрЃА
- Balance dashboard analytics
- Automated tax reporting

### Long Term

- Multiple bank integration (TBC, Liberty)
- Cryptocurrency payments
- Advanced reporting tools
- Mobile app notifications

---

**Contact**: admin@soulart.ge  
**Last Updated**: August 9, 2025  
**Version**: 1.0.0
